# 《幻境传说》游戏框架设计文档

---

## 1. 项目概述

### 1.1 项目目标
开发一款基于 Qt/C++/Python 技术栈的 2D 动作角色扮演游戏，支持跨平台运行（Windows/Linux/macOS），具备以下核心特性：
- **丰富的剧情系统**：6 个主线章节，50+ 支线任务，多重结局  
- **策略战斗系统**：连击、元素克制、状态效果  
- **角色成长系统**：3 种职业、技能树、装备强化  
- **动态世界系统**：NPC 关系、世界状态变化  

---

## 2. 技术架构

### 2.1 技术栈
| 技术       | 版本       | 用途                   | 优势                                 |
|------------|------------|------------------------|--------------------------------------|
| **Qt 6.3** | 最新稳定版 | UI 框架                | 跨平台、现代化、性能优秀             |
| **C++20**  | 现代标准   | 核心逻辑               | 高性能、内存安全、现代特性           |
| **Python 3.9+** | 稳定版   | 工具脚本               | 快速开发、丰富生态                   |
| **gRPC**   | 1.45+      | 服务间通信             | 高效、类型安全、支持多语言           |
| **CMake**  | 3.16+      | 构建系统               | 跨平台、现代化、功能强大             |
| **Docker** | 最新版     | 容器化部署             | 环境一致性、快速部署                 |

---

## 3. 分层架构设计

### 3.1 三层架构
```
┌──────────────────────────────┐
│     Python Tools Layer       │
├────────┬─────────────────────┤
│        │                     │
│        ▼                     │
│ ┌────────────────────────┐  │
│ │  Algorithm Service     │  │
│ │  (C++ gRPC Server)     │<─┼─┐
│ └────────────────────────┘  │ │
│                             │ │
│ ┌────────────────────────┐  │ │
│ │  Strategy Service      │  │ │
│ │  (C++ gRPC Server)     │──┼─┘
│ └────────────────────────┘  │
│                             │
│ ┌────────────────────────┐  │
│ │  Qt Application        │  │
│ │  (Game Client)         │  │
│ └────────────────────────┘  │
└──────────────────────────────┘
```

---

## 4. 核心模块设计

### 4.1 算法层（Algorithm Service）
#### 功能
- 战斗计算引擎（伤害公式、元素克制）  
- AI 行为决策树  
- 数据校验模块  

#### 接口定义
```protobuf
// algorithm.proto
service AlgorithmService {
  rpc CalculateDamage(CalculationRequest) returns (DamageResult);
  rpc GetSkillTree(SkillTreeRequest) returns (SkillTree);
  rpc AIActionDecision(AIDecisionRequest) returns (ActionResponse);
}
```

#### 实现方式
- 使用 C++20 + gRPC 实现  
- 编译为独立可执行文件（`algorithm-service`）  

---

### 4.2 策略层（Strategy Service）
#### 功能
- 游戏规则管理（战斗规则、剧情触发条件）  
- 世界状态管理系统（NPC 关系、动态世界）  
- 事件调度中心（任务触发、状态更新）  

#### 接口定义
```protobuf
// strategy.proto
service StrategyService {
  rpc GetGameRules(RulesRequest) returns (GameRules);
  rpc UpdateWorldState(WorldStateUpdate) returns (Status);
  rpc TriggerEvent(EventTrigger) returns (EventResult);
}
```

#### 实现方式
- 使用 C++20 + gRPC + SQLite 实现  
- 编译为独立可执行文件（`strategy-service`）  

---

### 4.3 应用层（Qt Application）
#### 功能
- UI 系统（QML + QtQuick）  
- 用户输入处理（战斗操作、菜单交互）  
- 资源管理系统（加载纹理、音效）  

#### 通信方式
- 通过 gRPC 调用策略层和算法层服务  
- 示例代码：
  ```cpp
  // 调用算法层计算伤害
  auto channel = grpc::CreateChannel("localhost:50051", grpc::InsecureChannelCredentials());
  auto stub = AlgorithmService::NewStub(channel);
  stub->CalculateDamage(&context, request, &result);
  ```

---

## 5. 通信协议设计

### 5.1 gRPC 通信规范
- 使用 Protobuf 3.20+  
- 服务间通信采用双向流式 gRPC  
- 数据格式标准化：
  ```protobuf
  message GameRequest {
    string session_id = 1;
    map<string, string> metadata = 2;
    bytes payload = 3;
  }
  ```

### 5.2 事件总线设计
- 使用 Redis Pub/Sub 实现跨服务事件通知  
- 事件类型示例：
  ```json
  {
    "event_type": "PLAYER_LEVEL_UP",
    "player_id": "12345",
    "new_level": 10
  }
  ```

---

## 6. 部署方案

### 6.1 容器化部署
#### Docker Compose 架构
```yaml
version: '3'
services:
  algorithm-service:
    build: ./algorithm
    ports:
      - "50051:50051"
  
  strategy-service:
    build: ./strategy
    ports:
      - "50052:50052"
  
  qt-game:
    build: ./application
    ports:
      - "8080:8080"
    depends_on:
      - algorithm-service
      - strategy-service
```

#### 服务编排
- 使用 Kubernetes 进行容器编排  
- 服务发现使用 Consul  
- 网络策略：
  - 服务间通信使用 mTLS 加密  
  - 客户端通信使用 JWT 认证  

---

## 7. 开发流程

### 7.1 开发模式
```
Python Tools
├── Config Generator (YAML/JSON)
├── Level Editor (PyQt)
├── Data Validator (Pandas)
└── Test Runner (pytest)

Algorithm Service
├── Unit Tests (Google Test)
└── Benchmark (Google Benchmark)

Strategy Service
├── Rule Tests (Catch2)
└── Integration Tests

Qt Application
└── UI Tests (Qt TestLib)
```

---

## 8. 性能优化

### 8.1 关键优化点
1. **内存管理**：
   - 使用 `jemalloc` 优化内存分配  
   - 对齐内存分配（`alignas(64)`）  

2. **线程模型**：
   - 算法层：工作窃取线程池  
   - 策略层：事件驱动架构  
   - 应用层：Qt 主线程 + 后台工作者线程  

3. **数据序列化**：
   - 热点数据使用 FlatBuffers  
   - 非实时数据使用 MessagePack  

---

## 9. 扩展性设计

### 9.1 插件系统
- 定义通用插件接口：
  ```cpp
  class GamePlugin {
  public:
    virtual void onLoad() = 0;
    virtual void onTick(float delta) = 0;
    virtual void onUnload() = 0;
  };
  ```
- 插件加载机制：
  - 使用 `dlopen/dlclose` 动态加载 `.so` 文件  
  - 插件配置通过 YAML 文件管理  

---

## 10. 附录

### 10.1 版本控制
- 使用 Git 子模块管理各服务  
- 采用语义化版本号（SemVer）  

### 10.2 CI/CD 流程
- GitHub Actions 自动构建  
- Conan 包管理依赖  
- 自动化测试套件  

---

## 11. 结论
本框架设计实现了严格的分层解耦，支持独立开发和部署。通过 gRPC 和 Protobuf 保证跨平台兼容性，容器化部署确保环境一致性。建议优先实现核心战斗系统的 POC，逐步扩展其他模块。